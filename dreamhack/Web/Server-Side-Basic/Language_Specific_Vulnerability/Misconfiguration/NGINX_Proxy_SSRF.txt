NGINX Proxy SSRF :
    Nginx에서 외부 이미지를 다운받아 화면에 보여주는 URL을 아래와 같이 구성하는 엔드포인트를 만드려고 합니다.
    StackOverflow 검색하면 아래 답변이 나옵니다.

    https://dreamhack.io/image/{image URL}
    https://dreamhack.io/image/http://imageviewer.com/941ba06f-fb7e-46e1-bcba-55a1306d6aa7.png

    The question is quite vague, but, based on the error message, 
    what you're trying to do is perform a proxy_pass entirely based on the user input, 
    by using the complete URL specified after the /image/ prefix of the URI.

    Basically, this is a very bad idea, as you're opening yourself to become an open proxy. 
    However, the reason it doesn't work as in the conf you supplied is due to URL normalisation, 
    which, in your case, compacts http://example into http:/example (double slash becomes single), 
    which is different in the context of proxy_pass.

    If you don't care about security, you can just change merge_slashes from the default of on to off:

    merge_slashes off;
    location …

    Another possibility is to somewhat related to nginx proxy_pass and URL decoding
    https://stackoverflow.com/questions/28995818/nginx-proxy-pass-and-url-decoding

    location ~ ^/image/.+ {
        rewrite ^ $request_uri;
        rewrite ^/image/(.*) $1 break;
        return 400;
        proxy_pass $uri; # will result in an open-proxy, don't try at home
    }

    Open-Proxy가 될 수 있다고 답변 작성자는 경고했지만 제대로 읽지 않고 그대로 사용할 경우 
    /image/ location에서 Server-Side-Request-Forgery(SSRF, SSRF 강의) 취약점이 발생해 
    nginx를 통해 내부 서비스 네트워크에 접근할 수 있습니다.

    위와 같은 설정에서 http://dreamhack.io/image/http://127.0.0.1:1234 를 접속하게 되면 
    로컬 호스트에서 연결이 맺어지는 것을 확인할 수 있습니다.

    root@u1804aws:~# nc -lvp 1234
    Listening on [0.0.0.0] (family 0, port 1234)
    Connection from localhost 59480 received!
    GET http://127.0.0.1:1234 HTTP/1.0
    Host: 127.0.0.1:1234
    Connection: close
    Upgrade-Insecure-Requests: 1
    User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.122 Safari/537.36
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp.image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
    Accept-Encoding: gzip, deflate
    Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7

    ^C
    root@u1804aws:~#

    공격 시나리오 :

    공격자 A : 내부 네트워크 접속 불가
    공격자 B : /image/http://127.0.0.1:8080/admin
        -> 잘못 설정된 웹서버 (nginx) -> 관리서버
                                        bind 127.0.0.1
                                        port 8080

조치 방안 :
    SSRF 취약점으로 부터 안전해지기 위해서 설정 파일을 수정해야 합니다. 
    개발자가 미리 정의한 호스트에게만 요청할 수 있도록 변경합니다.

    location ~ ^/image/(https?):/((?:hostA|hostB)(?::\d+)?)/(.*) {
        proxy_pass $1://$2/$3;
    }

    위 설정은 hostA와 hostB를 제외한 어떠한 호스트도 프록시 패스를 허용하지 않습니다.




