Nginx Alias Path Traversal
    Nginx에서 경로를 설정할 때 alias, root 두가지 방식이 있습니다.

    alias 기능 : http://nginx.org/en/docs/http/ngx_http_core_module.html#alias
        # Defines a replacement for the specified location. For example, with the following configuration
        location /i/ {
            alias /data/w3/images/;
        }
        # on request of “/i/top.gif”, the file /data/w3/images/top.gif will be sent.

    alias는 요청한 경로를 지시한 다른 경로로 변경하는 역할을 하지만 root 는 해당 경로의 root 경로를 명시해주는 역할을 합니다.

    alias는 http://server/i/top.gif 를 요청하면 /data/w3/images/top.gif 을 
    root는 /data/w3/images/images/top.gif를 가져옵니다.

    만약 사용자가 location을 지정할 때 /i/가 아닌 /i를 사용한다면 다음과 같은 상황이 발생합니다.

        location /i/ {
            http://server.com/i/hello.png -> /data/w3/images/hello.png
            
        location /i {
            http://server.com/i/hello.png -> /data/w3/images/hello.png
            http://server.com/i../hello.png -> /data/w3/images/../hello.png

    한 단계 상위 디렉토리의 파일을 가져올 수 있게 됩니다. 
    취약한 설정을 적용해 직접 서버에서 확인해보겠습니다.

    location /dreamhack {
            alias /tmp/;
    }

    syscall 트레이서인 strace를 이용해 nginx worker의 동작을 살펴보겠습니다.

    [00007f64a29e57ea] recvfrom(3, "GET /dreamhack/e.xxd HTTP/1.1\r\nA"..., 1024, 0, NULL, NULL) = 319
    [00007f64a29e5d2b] openat(AT_FDCWD, "/tmp//e.xxd", O_RDONLY|O_NONBLOCK) = 12
    ...
    [00007f64a29e57ea] recvfrom(3, "GET /dreamhack../etc/passwd HTTP"..., 1024, 0, NULL, NULL) = 326
    [00007f64a29e5d2b] openat(AT_FDCWD, "/tmp/../etc/passwd", O_RDONLY|O_NONBLOCK) = 12

    /dreamhack/e.xxd를 요청했을 때 /tmp//e.xxd 를 읽어오는 것을 확인할 수 있고 
    /dreamhack../etc/passwd를 요청하면 /tmp/../etc/passwd를 읽어옵니다.

조치 방안 :
    1) alias 대신에 root directive를 사용할 것을 권장합니다.
        - 약한 설정은 아래의 방식으로 조치할 수 있습니다.

            mkdir /tmp/dreamhack
            -----
            location /dreamhack/ {
                    root /tmp/
            }

    2)  location 마지막에 /를 붙이거나 alias 맨 뒤 /를 삭제해 조치하는 것입니다.
        
            [00007f64a29e57ea] recvfrom(3, "GET /dreamhack/e.xxd HTTP/1.1\r\nA"..., 1024, 0, NULL, NULL) = 319
            [00007f64a29e5d2b] openat(AT_FDCWD, "/tmp/e.xxd", O_RDONLY|O_NONBLOCK) = 12
            [00007f64a29e57ea] recvfrom(3, "GET /dreamhack../etc/passwd HTTP"..., 1024, 0, NULL, NULL) = 326
            [00007f64a29e5d2b] openat(AT_FDCWD, "/tmp../etc/passwd", O_RDONLY|O_NONBLOCK) = -1 ENOENT (No such file or directory)

            정상적인 요청은 openat이 성공하고 공격자의 요청은 ENOENT 에러와 함께 실패하는 것을 확인할 수 있습니다.


